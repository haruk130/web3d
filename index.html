<!-- made by haruki1234, 2022 -->
<!DOCTYPE html>
<html>
    <head>
        <title>3D</title>
        <meta charset="utf-8">

        <meta name="description" content="3D">
        <meta name="application-name" content="HarukiSite - 3D"/>
        <meta name="twitter:site" content="@haruki_1234_">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:image:src" content="https://haruki1234.github.io/web3d/3d.png">
        <meta property="og:type" content="website">
        <meta property="og:title" content="3D - haruki1234">
        <meta property="og:description" content="3Dの世界を移動できます">
        <meta property="og:site_name" content="HarukiSite">
        <meta property="og:image" content="https://haruki1234.github.io/web3d/3d.png">

    </head>
    <body>
        <div id="img_area">
            <img id="imgOutput" style="display: block;">
        </div>
        <div id="control_area" class="notselectable"><!--control-->
            <center>
                <div id="control">
                    <ul style="width: 100%;padding: 0;margin: 0;">
                        <li style="display: inline-block;"><center><p><span id="show_pos"></span></p></center></li>
                        <li style="display: inline-block;"><center><p>FPS: <span id="show_fps"></span></p></center></li>
                        <li style="display: inline-block;"><center><p><span id="debug"></span></p></center></li>
                    </ul>
                    <details id="control_details" open="true">
                        <summary style="font-size: 80%;">control</summary>
                        <table style="width: 100%;">
                            <tr>
                                <th style="width: 20%;"></th>
                                <th></th>
                                <th style="width: 20%;"></th>
                            </tr>
                            <!--
                            <tr>
                                <td style="width: 20%;"><button onclick="camera[0][0]+=1" style="width: 100%;">↑</button></td>
                                <td><center>X</center></td>
                                <td style="width: 20%;"><button onclick="camera[0][0]-=1" style="width: 100%;">↓</button></td>
                            </tr>
                            <tr>
                                <td><button onclick="camera[0][1]+=1" style="width: 100%;">↑</button></td>
                                <td><center>Y</center></td>
                                <td><button onclick="camera[0][1]-=1" style="width: 100%;">↓</button></td>
                            </tr>
                            <tr>
                                <td><button onclick="camera[0][2]+=1" style="width: 100%;">↑</button></td>
                                <td><center>Z</center></td>
                                <td><button onclick="camera[0][2]-=1" style="width: 100%;">↓</button></td>
                            </tr>
                            -->
                            <tr>
                                <td><button onclick="move(2)" style="width: 100%;">↑</button></td>
                                <td><center>Move</center></td>
                                <td><center></center></td>
                                <td><button onclick="move(-2)" style="width: 100%;">↓</button></td>
                            </tr>
                            <tr>
                                <td><button onclick="camera[1][0]+=12" style="width: 100%;">←</button></td>
                                <td><center>H</center></td>
                                <td><center></center></td>
                                <td><button onclick="camera[1][0]-=12" style="width: 100%;">→</button></td>
                            </tr>
                            <tr>
                                <td><button onclick="camera[1][1]-=12" style="width: 100%;">↑</button></td>
                                <td><center>V</center></td>
                                <td><center></center></td>
                                <td><button onclick="camera[1][1]+=12" style="width: 100%;">↓</button></td>
                            </tr>
                            <tr>
                                <td><button onclick="viewr(20)" style="width: 100%;">↑</button></td>
                                <td><center>View</center></td>
                                <td><center></center></td>
                                <td><button onclick="viewr(-20)" style="width: 100%;">↓</button></td>
                            </tr>
                            <tr>
                                <td><center>解像度</center></td>
                                <td>
                                    <select id="resolution">
                                    </select>
                                </td>
                            </tr>
                        </table>
                    </details>
                </div>
            </center>
        </div>
        <div id="footer" class="notselectable">
            <center>
                <pre><p>2022 haruki1234</p></pre>
            </center>
        </div>
    </body>
</html>
<script src="field/field.js"></script>
<script src="texture/field_blocks.js"></script>
<script>

    texture = field_blocks;

    setTimeout(move,10,50);
    setTimeout(mkimg,10);


    let cut_field;

    let backcolor = [100,150,200] // [r,g,b]

    let display_list = { // "name": [width,height,aspectraito(w),aspectraito(h),displayscale]
        "VGA": [640,480,4,3,9],
        "SVGA": [800,600,4,3,12],
        "XGA": [1024,768,4,3,15],
        "HD": [1280,720,16,9,18],
        "UXGA": [1600,1200,4,3,23],
        "FHD": [1980,1020,16,9,28],
        "4K": [3840,2160,16,9,54],
    };
    let display_resolution;

    {
        // make display resolution list
        drsel = document.getElementById("resolution");
        dlkeys = Object.keys(display_list);
        for (i=0;i<dlkeys.length;i++) {
            oel = document.createElement("option");
            if (i==0) {
                display_resolution = display_list[dlkeys[i]];
            }
            oel.value = dlkeys[i];
            oel.textContent = dlkeys[i];
            drsel.appendChild(oel);
        }
        drsel.onchange = event => {
            display_resolution = display_list[drsel.value];
            resizeImg();
        };
    }


    window.onresize = resizeImg;
    resizeImg(); // first resize


    let global_camera_pos;

    let cut_field_size = [800,800];
    let cut_field_pos = [cut_field_size[0]/2,cut_field_size[1]/2];
    let field_margin = cut_field_size;
    let max_range = 500; // 最大の描画範囲
    let min_range = 60; // 最小の描画範囲
    let view_range = 60; // 標準の描画範囲
    let view_angle = 70; // 視野角
    let camera = [
        [field_margin[0]/2,field_margin[1]/2,10], // 座標 [x,y,z]
        [180-45,0] // 向き [hrizontal,vertical] (degree)
    ];

    var startTime = Date.now();

    field = makemargin_field(field,10);
    fieldblock = makemargin_field(fieldblock,400);

    function viewr(n) {
        view_range += n;
        if (view_range>max_range) {
            view_range = max_range;
        }
        else if (view_range<min_range) {
            view_range = min_range;
        }
    }

    function makemargin_field(field,margin_fill) {
        console.log(field.length,field[0].length);
        rd = [];
        for (y=0;y<field_margin[1]-1;y++) {
            rd.unshift(new Array(field[0].length+field_margin[0]*2).fill(margin_fill));
        }
        rd.unshift(((new Array(field_margin[0]).fill(margin_fill)).concat(field[1])).concat(new Array(field_margin[0]).fill(margin_fill)));
        for (y=0;y<field.length;y++) {
            rd.unshift(((new Array(field_margin[0]).fill(margin_fill)).concat(field[y])).concat(new Array(field_margin[0]).fill(margin_fill)));
        }
        for (y=0;y<field_margin[1];y++) {
            rd.unshift(new Array(field[0].length+field_margin[0]*2).fill(margin_fill));
        }
        console.log(field.length+field_margin[0]*2,field[0].length+field_margin[1]*2);
        console.log(rd.length,rd[0].length);
        return rd;
    }

    function arrange_deg(x) {
        _d = (x)%360;
        if (_d<0) {_d = 360 + _d};
        return _d;
    }
    
    function move(l) {
        gpos = [camera[0][0]+cut_field_pos[0]-field_margin[0],camera[0][1]+cut_field_pos[1]-field_margin[1],camera[0][2].toString().substring(0,5)];
        los = rotate2d([0,-l],camera[1][0]);
        rs = 10000;
        xc = gpos[0] + Math.floor(los[0]*rs)/rs;
        yc = gpos[1] + Math.floor(los[1]*rs)/rs;
        cut_field_pos[0] += Math.floor(los[0]*rs)/rs;
        cut_field_pos[1] += Math.floor(los[1]*rs)/rs;
        if (xc<0) {
            cut_field_pos[0] = field_margin[0]/2;
        }
        if (yc<0) {
            cut_field_pos[1] = field_margin[1]/2;
        }
        if (field[0].length-field_margin[0]*2<xc) {
            cut_field_pos[0] = field_margin[1]/2+field[0].length-field_margin[0]*2;
        }
        if (field.length-field_margin[1]*2<yc) {
            cut_field_pos[1] = field_margin[1]/2+field.length-field_margin[1]*2;
        }
        cut_field = field_cut(field);
        cut_fieldblock = field_cut(fieldblock);
        // los = rotate2d([0,l],-camera[1][0])
        // camera[0][0] += los[0]
        // camera[0][1] += los[1]
        x = Math.floor(camera[0][0]);
        y = Math.floor(camera[0][1]);
        z = cut_field[y][x];
        camera[0][2] = z + 1.25;
        global_camera_pos = [camera[0][0]+cut_field_pos[0]-field_margin[0],camera[0][1]+cut_field_pos[1]-field_margin[1],camera[0][2].toString().substring(0,5)];
    }

    function field_cut(field) {
        ra = [];
        xc1 = Math.floor(cut_field_pos[0]/2)*2
        xc2 = xc1+cut_field_size[0]
        for (y=Math.floor(cut_field_pos[1]/2)*2+cut_field_size[1];y>cut_field_pos[1];y--) {
            ra.push(field[y].slice(xc1,xc2));
        }
        return ra;
    }

    function pos_3t2d(pos) { // get angle of camera and point
        let p1 = [pos[0]-camera[0][0],pos[1]-camera[0][1],pos[2]-camera[0][2]];
        let d_ = (Math.atan2(Math.abs(p1[0]),p1[1]))*180/Math.PI;
        if (p1[0]>=0) {d_ = 90-(90-d_);}
        else {d_ = 270+(90-d_);};
        let _d = arrange_deg(camera[1][0]);
        d1 = 180-arrange_deg(d_+(180-_d));
        let r_ = Math.sqrt(p1[0]**2+p1[1]**2);
        d_ = 360+arrange_deg((Math.atan2(r_,p1[2]))*180/Math.PI);
        let d2 = (360+arrange_deg(camera[1][1]+90)) - d_;
        return [d1,-d2];
    }

    function rotate3d(pos,r_x,r_y,r_z) {
        _x1 = pos[0];_y = pos[1];_z = pos[2];
        r_x = r_x *(Math.PI/180);
        r_y = r_y *(Math.PI/180);
        r_z = r_z *(Math.PI/180);
        _y2 = _y*Math.cos(r_x)-_z*Math.sin(r_x);
        _z1 = _y*Math.sin(r_x)+_z*Math.cos(r_x);
        _x2 = _x1*Math.cos(r_y)+_z1*Math.sin(r_y);
        _z3 = -_x1*Math.sin(r_y)+_z1*Math.cos(r_y);
        _x3 = _x2*Math.cos(r_z)-_y2*Math.sin(r_z);
        _y3 = _x2*Math.sin(r_z)+_y2*Math.cos(r_z);
        return [_x3,_y3,_z3];
    }

    function rotate2d(pos,r) {
        var _x = pos[0];_y = pos[1];
        r = r *(Math.PI/180);
        var x = _x*Math.cos(r)-_y*Math.sin(r);
        var y = _x*Math.sin(r)+_y*Math.cos(r);
        return [x,y];
    }
    
    function is_p(l1, l2) { // intersection point from 2 lines
        // 参考: ShanaBrain https://shanabrian.com/web/javascript/get-intersection-line-segments.php
        // 変更: 変数=>関数 連想配列=>配列 var=>let 変数名の変更 空白や改行の変更 判定の消去
        let x0=l1[0][0],y0=l1[0][1],x1=l1[1][0],y1=l1[1][1],x2=l2[0][0],y2=l2[0][1],x3=l2[1][0],y3=l2[1][1];
        let a0=(y1-y0)/(x1-x0),a1=(y3-y2)/(x3-x2);
        let x=(a0*x0-y0-a1*x2+y2)/(a0-a1),y=(y1-y0)/(x1-x0)*(x-x0)+y0;
        return [x,y];
    };
    function inclusion(p1, carr) {
        // 参考: https://qiita.com/ykob/items/6118b8e2e7ddcd8b6355
        // 変更: 変数=>関数 var=>let 変数名の変更 整数への丸めかたの変更 空白や改行の変更
        let deg=0; let p1x=p1[0]; let p1y=p1[1];
        let p3x,p3y;
        for (let index=0;index<carr.length;index++) {
            let p2x = carr[index][0]; let p2y = carr[index][1];
            if (index < carr.length - 1) {
                p3x = carr[index + 1][0]; p3y = carr[index + 1][1];
            } else {
                p3x = carr[0][0]; p3y = carr[0][1];
            }
            let ax = p2x-p1x; let ay = p2y-p1y; let bx = p3x-p1x; let by = p3y-p1y;
            let cos = (ax*bx+ay*by)/(Math.sqrt(ax*ax+ay*ay)*Math.sqrt(bx*bx+by*by));
            deg += Math.acos(cos)*(180/Math.PI);
        }
        if (Math.round(deg) == Math.round(360)) {
            return true;
        } else {
            return false;
        }
    };

    function mkimg() {

        x = display_resolution[0];
        y = display_resolution[1];
        canvasOutput = document.createElement("canvas");
        canvasOutput.height = y;canvasOutput.width = x;
        ctx = canvasOutput.getContext('2d');
        {
            fp= filed_to_polygon(cut_field,cut_fieldblock);
            csd_ps(ctx,fp);
            minimap(ctx);
            //console.table(ps)
        }
        document.getElementById("imgOutput").src = canvasOutput.toDataURL('image/png');

        document.getElementById("show_pos").innerHTML = ([(global_camera_pos[0]*1.28).toString().substring(0,5),(global_camera_pos[1]*1.28).toString().substring(0,5),(global_camera_pos[2]*1.28).toString().substring(0,5)]);
        nowTime = (Date.now() - startTime) / 1000;
        startTime = Date.now();
        document.getElementById("show_fps").innerHTML = ((1/nowTime).toString()).substring(0,5);
        setTimeout(mkimg,100);
    }

    function filed_to_polygon(field_,fblock_) {
        let rd = [];
        let f = field_;
        let b = fblock_;
        let bs = fieldbs/2;
        fx = cut_field_pos[0]%2;fy = cut_field_pos[1]%2; // position's fraction
        for (y=0;y<field_.length;y+=2) {
            for (x=0;x<field_[0].length;x+=2) {
                let len_b_c = squared_length2d([[camera[0][0],camera[0][1]],[x,y]])
                if (len_b_c<(view_range/1)**2 & len_b_c>1) {
                    y_=y+fy;x_=x-fx;
                    rd.push([[x_,y_,f[y][x]],[x_,y_-1,f[y-1][x]],[x_+1,y_-1,f[y-1][x+1]],[b[y][x+1],[[bs,bs],[bs,-bs+bs],[bs+bs,-bs+bs]]]]);
                    rd.push([[x_,y_,f[y][x]],[x_+1,y_,f[y][x+1]],[x_+1,y_-1,f[y-1][x+1]],[b[y][x+1],[[bs,bs],[bs+bs,bs],[bs+bs,-bs+bs]]]]);
                    rd.push([[x_,y_,f[y][x]],[x_+1,y_,f[y][x+1]],[x_+1,y_+1,f[y+1][x+1]],[b[y+1][x+1],[[bs,bs],[bs+bs,bs],[bs+bs,bs+bs]]]]);
                    rd.push([[x_,y_,f[y][x]],[x_,y_+1,f[y+1][x]],[x_+1,y_+1,f[y+1][x+1]],[b[y+1][x+1],[[bs,bs],[bs,bs+bs],[bs+bs,bs+bs]]]]);
                    rd.push([[x_,y_,f[y][x]],[x_,y_+1,f[y+1][x]],[x_-1,y_+1,f[y+1][x-1]],[b[y+1][x],[[bs,bs],[bs,bs+bs],[-bs+bs,bs+bs]]]]);
                    rd.push([[x_,y_,f[y][x]],[x_-1,y_,f[y][x-1]],[x_-1,y_+1,f[y+1][x-1]],[b[y+1][x],[[bs,bs],[-bs+bs,bs],[-bs+bs,bs+bs]]]]);
                    rd.push([[x_,y_,f[y][x]],[x_-1,y_-1,f[y-1][x-1]],[x_-1,y_,f[y][x-1]],[b[y][x],[[bs,bs],[-bs+bs,-bs+bs],[-bs+bs,bs]]]]);
                    rd.push([[x_,y_,f[y][x]],[x_-1,y_-1,f[y-1][x-1]],[x_,y_-1,f[y-1][x]],[b[y][x],[[bs,bs],[-bs+bs,-bs+bs],[bs,-bs+bs]]]]);
                }
            }
        }
        // for (i=0;i<rd.length;i++) {
        //     p = rd[i]
        //     a = [p[1][0]-p[0][0],p[1][1]-p[0][1],p[1][2]-p[0][2]]
        //     b = [p[2][0]-p[0][0],p[2][1]-p[0][1],p[2][2]-p[0][2]]
        //     ab = [a[0]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]
        //     lenab = length2d([ab,[0,0,0]])
        //     //rd[i].push([ab[0],ab[1],ab[2]])
        //     rd[i].push([ab[0]/lenab,ab[1]/lenab,ab[2]/lenab])
        // }
        return rd;
    }


    function minimap(ctx) {
        let slide= [15,15]; // slide
        let mappsize = [200,200]; // size of minimap
        let pimm= [0,60]; // position in mini map
        let cpimm= [slide[0]+50,slide[1]+50]; // compass position in mini map
        ctx.fillStyle = "rgb(250,255,255)";
        ctx.beginPath();
        ctx.fill();
        iarr = new Uint8ClampedArray(mappsize[0] * mappsize[1] * 4);
        for (iy = 0; iy < mappsize[1]; iy++) {
            for (ix = 0; ix < mappsize[0]; ix++) {
                index = (iy*mappsize[0]+ix)*4; // index of position [ix,iy]
                pxpos = rotate2d([ix-mappsize[0]/2-pimm[0],iy-mappsize[1]/2-pimm[1]],-camera[1][0]);
                pxp = cut_field[Math.floor(-pxpos[1]+camera[0][1])][Math.floor(-pxpos[0]+camera[0][0])];
                iarr[index+0] = 0; // Red
                iarr[index+1] = pxp*5; // Green
                iarr[index+2] = 0; // Blue
                iarr[index+3] = 250; // Alpha
            }
        }
        ctx.putImageData(new ImageData(iarr,mappsize[0],mappsize[1]),slide[0],slide[1]);

        { // compass
            ctx.fillStyle = "rgb(20,10,20)"
            ctx.beginPath();
            ctx.arc(cpimm[0], cpimm[1], 40, 0, 2 * Math.PI);
            ctx.fill();
            ctx.lineWidth = 7;
            los = rotate2d([0,35],camera[1][0]);
            ctx.strokeStyle = "rgb(255,100,110)";
            ctx.beginPath();
            ctx.moveTo(los[0]+cpimm[0], los[1]+cpimm[1]);
            ctx.lineTo(cpimm[0], cpimm[1]);
            ctx.stroke();
            ctx.strokeStyle = "rgb(220,220,250)";
            ctx.beginPath();
            ctx.moveTo(cpimm[0], cpimm[1]);
            ctx.lineTo(-los[0]+cpimm[0], -los[1]+cpimm[1]);
            ctx.stroke();
        }
        ctx.fillStyle = "rgb(250,0,0)";
        ctx.beginPath();
        ctx.arc(mappsize[0]/2+pimm[0]+slide[0], mappsize[1]/2+pimm[1]+slide[1], 7, 0, 2 * Math.PI);
        ctx.fill();
    }

    function length3d(pos) {
        return Math.sqrt((pos[0][0]-pos[1][0])**2+(pos[0][1]-pos[1][1])**2+(pos[0][2]-pos[1][2])**2);
    }
    function length2d(pos) {
        return Math.sqrt( (pos[0][0]-pos[1][0])**2+(pos[0][1]-pos[1][1])**2 );
    }
    function squared_length3d(pos) {
        return (pos[0][0]-pos[1][0])**2+(pos[0][1]-pos[1][1])**2+(pos[0][2]-pos[1][2])**2;
    }
    function squared_length2d(pos) {
        return (pos[0][0]-pos[1][0])**2+(pos[0][1]-pos[1][1])**2;
    }

    function csd_ps(ctx,ps) {
        let tmpa = [];let ra = [];
        let cp = [camera[0][0]*3,camera[0][1]*3,camera[0][2]];
        let i;let j;
        vangler = view_angle/2 * ( Math.PI / 180 );
        for (i=0;i<ps.length;i++) {
            pos = [ps[i][0][0]+ps[i][1][0]+ps[i][2][0],ps[i][0][1]+ps[i][1][1]+ps[i][2][1],ps[i][0][2]+ps[i][1][2]+ps[i][2][2]]
            var len = squared_length3d([cp,pos]);
            rtd = rotate2d([pos[0]-cp[0],pos[1]-cp[1]],camera[1][0]);
            if (rtd[1]>-10) {
                if (Math.atan2(Math.abs(rtd[0]),rtd[1]+4) < vangler) {
                    tmpa.push([len,i]);
                }
            }
        }
        tmpal = tmpa.length;
        // sort polygon to length
        let backup;i=0;
        while (i<tmpal) {
            j=0;jm = tmpal-i-1;
            while (j<jm) {
                if (tmpa[j][0]<tmpa[j+1][0]) {
                    backup = tmpa[j+1];tmpa[j+1] = tmpa[j];tmpa[j] = backup;
                }
                j=(j+1)|0;
            }
            i=(i+1)|0;
        }
        // draw polygon with texture
        x = display_resolution[0];
        y = display_resolution[1];
        tiarr = new Uint8ClampedArray(x * y * 4);
        for (iy = 0; iy < y; iy++) {
            for (ix = 0; ix < x; ix++) {
                    index = (iy*x+ix)*4; // index of position [ix,iy]
                    tiarr[index+0] = backcolor[0]; // Red
                    tiarr[index+1] = backcolor[1]; // Green
                    tiarr[index+2] = backcolor[2]; // Blue
                    tiarr[index+3] = 255; // Alpha
            }
        }
        s = display_resolution[4];
        for (i=0;i<tmpal;i++) {
            p = ps[tmpa[i][1]];
            lookrange = view_angle/2;
            let p1 = pos_3t2d(p[0]);let p2 = pos_3t2d(p[1]);let p3 = pos_3t2d(p[2]);
            if (Math.abs(p1[0])>lookrange) {
                if (Math.abs(p2[0])>lookrange) {
                    if (Math.abs(p3[0])>lookrange) { f = false; }
                }
            }
            c = (p[0][2]+p[1][2]+p[2][2])/3;c*=5;
            slide = [display_resolution[0]/2,display_resolution[1]/2];
            dpos = [[Math.floor(p1[0]*s+slide[0]),Math.floor(p1[1]*s+slide[1])],[Math.floor(p2[0]*s+slide[0]),Math.floor(p2[1]*s+slide[1])],[Math.floor(p3[0]*s+slide[0]),Math.floor(p3[1]*s+slide[1])]];
            xmax = Math.max(dpos[0][0],dpos[1][0],dpos[2][0]);
            xmin = Math.min(dpos[0][0],dpos[1][0],dpos[2][0]);
            ymax = Math.max(dpos[0][1],dpos[1][1],dpos[2][1]);
            ymin = Math.min(dpos[0][1],dpos[1][1],dpos[2][1]);
            img = texture[p[3][0]];
            if (img!=null) {
                i2p = p[3][1]; // texture triangle
                i1p = dpos; // draw triangle
                for (iy = ymin; iy < ymax; iy++) {
                    for (ix = xmin; ix < xmax; ix++) {
                        if (iy>0 && ix>0 && ix<x && iy<y) {// in display
                            index = ((iy)*x+(ix))*4; // index of position [ix,iy]
                            if (inclusion([ix,iy],i1p)) {
                                pos = is_p( [i1p[0],[ix,iy]],[i1p[1],i1p[2]]);
                                if (pos!=false) {
                                    bd=length2d([i1p[1],pos]);dc=length2d([i1p[2],pos]);ap=length2d([i1p[0],[ix,iy]]);pd=length2d([pos,[ix,iy]]);
                                    x1=i2p[1][0];x2=i2p[2][0];y1=i2p[1][1];y2=i2p[2][1];dd=[(bd*(x2-x1))/(bd+dc)+x1,(dc*(y1-y2))/(bd+dc)+y2];
                                    x1=i2p[0][0];x2=dd[0];y1=i2p[0][1];y2=dd[1];pdd=[(ap*(x2-x1))/(ap+pd)+x1,(pd*(y1-y2))/(ap+pd)+y2];
                                    if (isNaN(pdd[0])!=true) {
                                        pxy = Math.floor(pdd[0])%img[1].length;
                                        if (pxy<0) {
                                            pxy = img[1].length+pxy;
                                        }
                                        pxx = Math.floor(pdd[1]%img.length);
                                        if (pxx<0) {
                                            pxx = img.length+pxx;
                                        }
                                        px = img[pxx][pxy];
                                        tiarr[index+0] = px[0];tiarr[index+1] = px[1];tiarr[index+2] = px[2];tiarr[index+3] = px[3];
                                    }
                                }
                            }
                        } 
                    }
                }
            }
        }
        ctx.putImageData(new ImageData(tiarr, x, y),0,0);
    }


// keyboard
document.onkeydown = function(e) {
    keystatus_d[event.keyCode] = true;
    if (event.keyCode in keyw) {
        keyw[event.keyCode]();
    }
    document.getElementById("control_details").open=false;
};
document.onkeyup = function(e) {
    keystatus_d[event.keyCode] = false;
};

let keyd = {}
{
    keyd[87] = ()=>move(3);
    keyd[83] = ()=>move(-3);
    keyd[65] = ()=>camera[1][0]+=3;
    keyd[68] = ()=>camera[1][0]-=3;
    keyd[82] = ()=>camera[1][1]-=3;
    keyd[70] = ()=>camera[1][1]+=3;
}
let keyw = {}
{
    keyw[87] = ()=>move(0.05);
    keyw[83] = ()=>move(-0.05);
    keyw[65] = ()=>camera[1][0]+=1;
    keyw[68] = ()=>camera[1][0]-=1;
    keyw[82] = ()=>camera[1][1]-=1;
    keyw[70] = ()=>camera[1][1]+=1;
}
let keystatus_d = {};

function keyinput() {
    keys = Object.keys(keystatus_d);
    for (i=0;i<keys.length;i++) {
        if (keystatus_d[keys[i]]) {
            if (keys[i] in keyw) {
                keyw[keys[i]]();
            }
        }
    }
}
setInterval(keyinput,100)

// safari 拡大縮小阻止
// 参考 https://iphone.f-tools.net/html5/Kakudai-Kinsi.html
document.documentElement.addEventListener('touchstart', function (e) {
    if (e.touches.length >= 2) {e.preventDefault();}
}, {passive: false});

var t = 0;
document.documentElement.addEventListener('touchend', function (e) {
var now = new Date().getTime();
if ((now - t) < 350){
    e.preventDefault();
}
t = now;
}, false);


// resize window
function resizeImg() {
    dw = display_resolution[2];
    dh = display_resolution[3];
    let bottom_area = 17;
    let ww = window.innerWidth;
    let rw = 0;let rh = 0;let vm = 1;let hm = 1;
    let wh = window.innerHeight-bottom_area-vm;
    if (ww*dh>wh*dw) {
        rw = wh*dw/dh;
        rh = wh;
        hm += (ww-rw)/2;
    }
    else {
        rw = ww;
        rh = ww*dh/dw;
        vm += (wh-rh)/2;
    }
    document.getElementById("imgOutput").style.marginTop = (vm).toString()+"px";
    document.getElementById("imgOutput").style.marginBottom = (vm).toString()+"px";
    document.getElementById("imgOutput").style.marginLeft = (hm).toString()+"px";
    document.getElementById("imgOutput").style.marginRight = (hm).toString()+"px";
    document.getElementById("imgOutput").style.width = (rw).toString()+"px";
    document.getElementById("imgOutput").style.height = (rh).toString()+"px";
};

</script>
<style>
.notselectable {
    -ms-user-select: none;
    -moz-user-select: -moz-none;
    -khtml-user-select: none;
    -webkit-user-select: none;
    user-select: none;
}
#footer {
    position: absolute;
    font-size: 10px;
    width: 100%;
    height: 17px;
    bottom: 0px;
    left: 0px;
    background: rgba(171,243,231,0.6);
}
pre {
    display: inline;
    margin: 0;
}

body::-webkit-scrollbar {
    display: none;
}
body {
    overflow: hidden;
    -ms-overflow-style: none;    /* IE, Edge 対応 */
    scrollbar-width: none;       /* Firefox 対応 */
    background: rgb(0,0,0);
}

p {
    margin: 3px;
}

#img_area {
    top: 0;
    left: 0;
    position: absolute;
    z-index: -1;
}

#control_area {
    width: 100%;
    top: 10px;
    left: 0px;
    position: absolute;
    font-size: 95%;
}

#control {
    padding: 5px;
    border-radius: 5px;
    background: rgba(255,255,255,0.6);
    width: 400px;
}
</style>


<script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-analytics.js"></script>
<script>
var firebaseConfig = {
    apiKey: "AIzaSyDLLs9K4E9UVTmP2XaHhn_UzXtlN1nCDXc",
    authDomain: "github-b0aea.firebaseapp.com",
    projectId: "github-b0aea",
    storageBucket: "github-b0aea.appspot.com",
    messagingSenderId: "539611850738",
    appId: "1:539611850738:web:57da8d1bd3bcf69a7a2d6b",
    measurementId: "G-F2XPLPFDJ5"
};
firebase.initializeApp(firebaseConfig);
if (location.hostname == "haruki1234.github.io") {
    firebase.analytics();
}
</script>