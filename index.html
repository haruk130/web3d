<!-- made by haruki1234, 2022 -->
<!DOCTYPE html>
<html>
    <head>
        <title>3D</title>
        <meta charset="utf-8">

        <meta name="description" content="3D">
        <meta name="application-name" content="HarukiSite - 3D"/>
        <meta name="twitter:site" content="@haruki_1234_">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:image:src" content="https://haruki1234.github.io/web3d/3d.png">
        <meta cam_property="og:type" content="website">
        <meta cam_property="og:title" content="3D - haruki1234">
        <meta cam_property="og:description" content="3Dの世界を移動できます">
        <meta cam_property="og:site_name" content="HarukiSite">
        <meta cam_property="og:image" content="https://haruki1234.github.io/web3d/3d.png">

    </head>
    <body>
        <div id="img_area">
            <img id="imgOutput" style="display: block;filter: blur(0.5px);">
        </div>
        <div id="control_area" class="notselectable"><!--control-->
            <center>
                <div id="control">
                    <ul style="width: 100%;padding: 0;margin: 0;">
                        <li style="display: inline-block;"><center><p><span id="show_pos"></span></p></center></li>
                        <li style="display: inline-block;"><center><p>FPS: <span id="show_fps"></span></p></center></li>
                        <li style="display: inline-block;"><center><p><span id="block_pos"></span></p></center></li>
                        <li style="display: inline-block;"><center><p><span id="debug"></span></p></center></li>
                    </ul>
                </div>
            </center>
        </div>
        <div id="footer" class="notselectable">
            <center>
                <pre><p>2022 haruki1234</p></pre>
            </center>
        </div>
    </body>
</html>
<script>

let cam_property = [
    [3,2,3],//camera position [x,y,z] (block)
    [-130,0,90],//camera angle [h,v,scale] (degree)
    [500,500],//display
]
var startTime = Date.now();

cube = [ [0,0,20,10],
    [
        [[1,1,2],[-1,1,2],[-1,-1,2],[100000],[0,0],[0,128],[128,128]],
        [[1,1,2],[-1,-1,2],[1,-1,2],[100000],[0,0],[0,128],[128,128]],
        [[1,-1,0],[1,-1,2],[-1,-1,2],[100000],[0,0],[0,128],[128,128]],
        [[1,-1,0],[-1,-1,2],[-1,-1,0],[100000],[0,0],[0,128],[128,128]],
        [[-1,-1,0],[-1,-1,2],[-1,1,2],[100000],[0,0],[0,128],[128,128]],
        [[-1,-1,0],[-1,1,2],[-1,1,0],[100000],[0,0],[0,128],[128,128]],
        [[-1,1,0],[1,1,0],[1,-1,0],[100000],[0,0],[0,128],[128,128]],
        [[-1,1,0],[1,-1,0],[-1,-1,0],[100000],[0,0],[0,128],[128,128]],
        [[1,1,0],[1,1,2],[1,-1,2],[100000],[0,0],[0,128],[128,128]],
        [[1,1,0],[1,-1,2],[1,-1,0],[100000],[0,0],[0,128],[128,128]],
        [[-1,1,0],[-1,1,2],[1,1,2],[100000],[0,0],[0,128],[128,128]],
        [[-1,1,0],[1,1,2],[1,1,0],[100000],[0,0],[0,128],[128,128]],
    ]
]

polygons = cube[1]

mkimg()

    function mkimg() {
        x = cam_property[2][0]
        y = cam_property[2][1]
        let co = document.createElement("canvas");
        co.height=y;co.width=x;
        ctx = co.getContext('2d');
        let iarr = new Uint8ClampedArray(x*y*4);
        for (let iy = 0; iy < y; iy++) {
            for (let ix = 0; ix < x; ix++) {
                let index = (iy*x+ix)*4; // index of position [ix,iy]
                iarr[index+0] = 100; // Red
                iarr[index+1] = 100; // Green
                iarr[index+2] = 100; // Blue
                iarr[index+3] = 255; // Alpha
            }
        }
        for (i=0;i<polygons.length;i++) {
            t = polygons[i]
            p1 = pos_3t2d(t[0])
            p2 = pos_3t2d(t[1])
            p3 = pos_3t2d(t[2])
            dp = [p1,p2,p3];
            v12 = [t[1][0]-t[0][0],t[1][1]-t[0][1],t[1][2]-t[0][2]]
            v23 = [t[2][0]-t[1][0],t[2][1]-t[1][1],t[2][2]-t[1][2]]
            vt = vc(v12,v23)//法線

            // xmax = Math.max(dp[0][0],dp[1][0],dp[2][0]);
            // xmin = Math.min(dp[0][0],dp[1][0],dp[2][0]);
            // ymax = Math.max(dp[0][1],dp[1][1],dp[2][1]);
            // ymin = Math.min(dp[0][1],dp[1][1],dp[2][1]);
            

            xmax = Math.min(Math.max(dp[0][0],dp[1][0],dp[2][0]),cam_property[2][0]);
            xmin = Math.max(Math.min(dp[0][0],dp[1][0],dp[2][0]),0);
            ymax = Math.min(Math.max(dp[0][1],dp[1][1],dp[2][1]),cam_property[2][0]);
            ymin = Math.max(Math.min(dp[0][1],dp[1][1],dp[2][1]),0);

            for (iy = ymin; iy < ymax; iy++) {
                for (ix = xmin; ix < xmax; ix++) {
                    if (iy>0 && ix>0 && ix<x && iy<y) {// in display
                        if (inclusion([ix,iy],dp)) {
                            index = ((iy)*x+(ix))*4; // index of position [ix,iy]
                            iarr[index+0] = i*20;
                            iarr[index+1] = 200;
                            iarr[index+2] = 10;
                        }
                    }
                }
            }
        }
        ctx.putImageData(new ImageData(iarr,x,y),0,0);
        document.getElementById("imgOutput").src = co.toDataURL('image/png');
        fps = (Date.now() - startTime) / 1000;
        startTime = Date.now();
        document.getElementById("show_fps").innerHTML = ((1/fps).toString()).substring(0,5);
        setTimeout(mkimg,10);
    }
    function vc(a,b) {
        return [a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[0]*b[0]]
    }

    function inclusion(p1, carr) {
        let a = [carr[0][0]-p1[0],carr[0][1]-p1[1]]
        let b = [carr[1][0]-p1[0],carr[1][1]-p1[1]]
        let c = [carr[2][0]-p1[0],carr[2][1]-p1[1]]
        let ab = (a[0]*b[1]-a[1]*b[0])
        let bc = (b[0]*c[1]-b[1]*c[0])
        let ca = (c[0]*a[1]-c[1]*a[0])
        return ab>=0&&bc>=0&&ca>=0
    };

    function pos_3t2d(pos) { // get angle of camera and point
        let cp = cam_property[0];let ca = cam_property[1];
        let p1 = [pos[0]-cp[0],pos[1]-cp[1],pos[2]-cp[2]];
        d_ = (Math.atan2(Math.abs(p1[0]),p1[1]))*180/Math.PI;
        if (p1[0]<0) {d_=360-d_;};
        let d1 = 180-arrange_deg(d_-ca[0]+180);
        let r_ = Math.sqrt(p1[0]**2+p1[1]**2);
        d_ = ((Math.atan2(r_,p1[2]))*180/Math.PI);
        let d2 = 180 - arrange_deg(d_-ca[1]+180);
        let s = cam_property[2][0]/ca[2];
        s = 1;
        let d = [d1*s+cam_property[2][0]/2,d2*s+cam_property[2][1]/2];
        return [Math.floor(d[0]),Math.floor(d[1])];
    }
    function pos_3t2d(pos) { // get angle of camera and point
        let cp = cam_property[0];let ca = cam_property[1];
        let p1 = [pos[0]-cp[0],pos[1]-cp[1],pos[2]-cp[2]];

        d_ = (Math.atan2(Math.abs(p1[0]),p1[1]))*180/Math.PI;
        if (p1[0]<0) {d_=360-d_;};
        let d1 = 180-arrange_deg(d_-ca[0]+180);

        let r_ = Math.sqrt(p1[0]**2+p1[1]**2);
        d_ = (Math.atan2(Math.abs(r_),p1[2]))*180/Math.PI;
        if (true) {d_=360-d_;};
        let d2 = 180-arrange_deg(d_-ca[1]+180);

        let s = cam_property[2][0]/ca[2];
        let d = [d1*s+cam_property[2][0]/2,d2*s+cam_property[2][1]/2];
        return [Math.floor(d[0]),Math.floor(d[1])];
    }
    function pos_3t2d(pos) { // get angle of camera and point
        let cp = cam_property[0];let ca = cam_property[1];
        let p1 = [pos[0]-cp[0],pos[1]-cp[1],pos[2]-cp[2]];

        d_ = (Math.atan2(Math.abs(p1[0]),p1[1]))*180/Math.PI;
        if (p1[0]<0) {d_=360-d_;};
        let d1 = 180-arrange_deg(d_-ca[0]+180);

        let r_ = Math.sqrt(p1[0]**2+p1[1]**2);
        d_ = (Math.atan2(Math.abs(r_),p1[2]))*180/Math.PI;
        if (true) {d_=360-d_;};
        let d2 = 180-arrange_deg(d_-ca[1]+180+90);

        let s = cam_property[2][0]/ca[2];
        let d = [d1*s+cam_property[2][0]/2,d2*s+cam_property[2][1]/2];
        return [Math.floor(d[0]),Math.floor(d[1])];
    }


    function pos_3t2d(pos) { // get angle of camera and point
        let cp = cam_property[0];let ca = cam_property[1];
        let p1 = [pos[0]-cp[0],pos[1]-cp[1],pos[2]-cp[2]];

        p1 = rotate3d_z(p1,ca[0])
        p1 = rotate3d_x(p1,-ca[1])

        d_ = (Math.atan2(Math.abs(p1[0]),p1[1]))*180/Math.PI;
        if (p1[0]<0) {d_=360-d_;};
        let d1 = 180-arrange_deg(d_+180);
        let r_ = Math.sqrt(p1[0]**2+p1[1]**2);
        let d2 = ((Math.atan2(r_,p1[2]))*180/Math.PI) - 90;

        let s = cam_property[2][0]/ca[2];
        let d = [d1*s+cam_property[2][0]/2,d2*s+cam_property[2][1]/2];
        return [Math.floor(d[0]),Math.floor(d[1])];
    }
    function pos_3t2d(pos) { // get angle of camera and point
        let cp = cam_property[0];let ca = cam_property[1];
        let p1 = [pos[0]-cp[0],pos[1]-cp[1],-(pos[2]-cp[2])];

        p1 = rotate3d_z(p1,ca[0])
        p1 = rotate3d_x(p1,-ca[1]+90)

        let param = [
            [10,0,0],
            [0,10,0],
            [0,0,1],
        ]
        td = dot(param,[[p1[0]],[p1[1]],[p1[2]]])
        let d1 = td[0][0]
        let d2 = td[1][0]

        let s = cam_property[2][0]/ca[2];
        s = 1
        let d = [-d1*s+cam_property[2][0]/2,-d2*s+cam_property[2][1]/2];
        return [Math.floor(d[0]),Math.floor(d[1])];
    }
    function pos_3t2d(pos) { // get angle of camera and point
        let cp = cam_property[0];let ca = cam_property[1];
        let p1 = [pos[0]-cp[0],pos[1]-cp[1],pos[2]-cp[2]];
        p1 = rotate3d_z(p1,ca[0])
        p1 = rotate3d_x(p1,-ca[1])
        l = Math.abs(14/(p1[1]))
        
        let s = cam_property[2][0]/2;
        s = 20;
        let d = [-p1[0]*l*s+cam_property[2][0]/2,-p1[2]*l*s+cam_property[2][1]/2];
        return [Math.floor(d[0]),Math.floor(d[1])];
    }

    function rotate3d_x(pos,r_x) {
        _x1 = pos[0];_y1 = pos[1];_z1 = pos[2];
        r_x = r_x *(Math.PI/180);
        _x3 = _x1;
        _y3 = _y1*Math.cos(r_x)-_z1*Math.sin(r_x);
        _z3 = _y1*Math.sin(r_x)+_z1*Math.cos(r_x);
        return [_x3,_y3,_z3];
    }
    function rotate3d_z(pos,r_z) {
        _x1 = pos[0];_y1 = pos[1];_z1 = pos[2];
        r_z = r_z *(Math.PI/180);
        _z3 = _z1;
        _x3 = _x1*Math.cos(r_z)-_y1*Math.sin(r_z);
        _y3 = _x1*Math.sin(r_z)+_y1*Math.cos(r_z);
        return [_x3,_y3,_z3];
    }
    function dot(matrix1, matrix2){ // https://qiita.com/rubyfmzk_/items/beaa0b324b4e74de96f5
        var res = [];
        var row1 = matrix1.length;
        var row2 = matrix2.length;
        var col1 = matrix1[0].length;
        var col2 = matrix2[0].length;
        for(var i1 = 0; i1 < row1; i1++){
            res.push([]);
            for(var i2 = 0; i2 < col2; i2++){
            res[i1].push(0);
            for(var i3 = 0; i3 < col1; i3++){
                res[i1][i2] += matrix1[i1][i3] * matrix2[i3][i2];
            }
            }
        }
        return res;
    }
    

    function arrange_deg(x) {
        _d = (x+360)%360;
        return _d;
    }

    function rotate3d(pos,r_x,r_y,r_z) {
        _x1 = pos[0];_y = pos[1];_z = pos[2];
        r_x = r_x *(Math.PI/180);
        r_y = r_y *(Math.PI/180);
        r_z = r_z *(Math.PI/180);
        _y2 = _y*Math.cos(r_x)-_z*Math.sin(r_x);
        _z1 = _y*Math.sin(r_x)+_z*Math.cos(r_x);
        _x2 = _x1*Math.cos(r_y)+_z1*Math.sin(r_y);
        _z3 = -_x1*Math.sin(r_y)+_z1*Math.cos(r_y);
        _x3 = _x2*Math.cos(r_z)-_y2*Math.sin(r_z);
        _y3 = _x2*Math.sin(r_z)+_y2*Math.cos(r_z);
        return [_x3,_y3,_z3];
    }
    function rotate2d(pos,r) {
        var _x = pos[0];_y = pos[1];
        r = r *(Math.PI/180);
        var x = _x*Math.cos(r)-_y*Math.sin(r);
        var y = _x*Math.sin(r)+_y*Math.cos(r);
        return [x,y];
    }

    function move(l) {
        los = rotate2d([0,l],-cam_property[1][0]);
        cam_property[0][0] += los[0];
        cam_property[0][1] += los[1];
    }
// keyboard
document.onkeydown = function(e) {
    keystatus_d[event.keyCode] = true;
};
document.onkeyup = function(e) {
    keystatus_d[event.keyCode] = false;
};
let keyw = {}
{
    keyw[87] = ()=>move(0.5);
    keyw[83] = ()=>move(-0.5);
    keyw[65] = ()=>cam_property[1][0]+=6;
    keyw[68] = ()=>cam_property[1][0]-=6;
    keyw[82] = ()=>cam_property[1][1]+=6;
    keyw[70] = ()=>cam_property[1][1]-=6;
}
let keystatus_d = {};
function keyinput() {
    keys = Object.keys(keystatus_d);
    for (i=0;i<keys.length;i++) {
        if (keystatus_d[keys[i]]) {
            if (keys[i] in keyw) {
                keyw[keys[i]]();
            }
        }
    }
}
setInterval(keyinput,100)

// resize window
    function resizeImg() {
        dw = cam_property[2][0];
        dh = cam_property[2][1];
        let bottom_area = 17;
        let ww = window.innerWidth;
        let rw = 0;let rh = 0;let vm = 1;let hm = 1;
        let wh = window.innerHeight-bottom_area-vm;
        if (ww*dh>wh*dw) {
            rw = wh*dw/dh;
            rh = wh;
            hm += (ww-rw)/2;
        }
        else {
            rw = ww;
            rh = ww*dh/dw;
            vm += (wh-rh)/2;
        }
        document.getElementById("imgOutput").style.marginTop = (vm).toString()+"px";
        document.getElementById("imgOutput").style.marginBottom = (vm).toString()+"px";
        document.getElementById("imgOutput").style.marginLeft = (hm).toString()+"px";
        document.getElementById("imgOutput").style.marginRight = (hm).toString()+"px";
        document.getElementById("imgOutput").style.width = (rw).toString()+"px";
        document.getElementById("imgOutput").style.height = (rh).toString()+"px";
    };
window.onresize = resizeImg;
resizeImg(); // first resize

</script>
<style>
.notselectable {
    -ms-user-select: none;
    -moz-user-select: -moz-none;
    -khtml-user-select: none;
    -webkit-user-select: none;
    user-select: none;
}
#footer {
    position: absolute;
    font-size: 10px;
    width: 100%;
    height: 17px;
    bottom: 0px;
    left: 0px;
    background: rgba(171,243,231,0.6);
}
pre {
    display: inline;
    margin: 0;
}

body::-webkit-scrollbar {
    display: none;
}
body {
    overflow: hidden;
    -ms-overflow-style: none;    /* IE, Edge 対応 */
    scrollbar-width: none;       /* Firefox 対応 */
    background: rgb(0,0,0);
}

p {
    margin: 3px;
}

#img_area {
    top: 0;
    left: 0;
    position: absolute;
    z-index: -1;
}

#control_area {
    width: 100%;
    top: 10px;
    left: 0px;
    position: absolute;
    font-size: 95%;
}

#control {
    padding: 5px;
    border-radius: 5px;
    background: rgba(255,255,255,0.6);
    width: 500px;
}
</style>


<script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-analytics.js"></script>
<script>
var firebaseConfig = {
    apiKey: "AIzaSyDLLs9K4E9UVTmP2XaHhn_UzXtlN1nCDXc",
    authDomain: "github-b0aea.firebaseapp.com",
    projectId: "github-b0aea",
    storageBucket: "github-b0aea.appspot.com",
    messagingSenderId: "539611850738",
    appId: "1:539611850738:web:57da8d1bd3bcf69a7a2d6b",
    measurementId: "G-F2XPLPFDJ5"
};
firebase.initializeApp(firebaseConfig);
if (location.hostname == "haruki1234.github.io") {
    firebase.analytics();
}
</script>